<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>MCQ Quiz</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Geist+Mono:wght@100..900&family=Geist:wght@100..900&display=swap" rel="stylesheet">



  <script>
    // Helper to typeset MathJax in dynamic regions
    function __typesetMath(el){
      try {
        if (window.MathJax && MathJax.typesetPromise) {
          return MathJax.typesetPromise(el ? [el] : undefined).catch(function(){});
        }
      } catch(_) {}
      return Promise.resolve();
    }
    // MathJax configuration for LaTeX rendering
    window.MathJax = {
      tex: {
        inlineMath: [['$', '$'], ['\\(', '\\)']],
        displayMath: [['$$', '$$'], ['\\[', '\\]']],
        processEscapes: true,
        processEnvironments: true
      },
      options: {
        skipHtmlTags: ['script','noscript','style','textarea','pre','code'],
        ignoreHtmlClass: 'tex2jax_ignore',
        processHtmlClass: 'tex2jax_process'
      },
      svg: { fontCache: 'global' },
      startup: { typeset: false }
    };
  </script>
  <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-svg.js"></script>
  <script>
    // Apply saved or system theme early to avoid flash
    (function(){
      try {
        var saved = localStorage.getItem('theme');
        var prefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
        var theme = saved || (prefersDark ? 'dark' : 'light');
        document.documentElement.setAttribute('data-theme', theme);
      } catch (_) {}
    })();
  </script>
  <style>
    :root {
      --bg: #fbfbfd;
      --card: #ffffff;
      --text: #111111;
      --muted: #6e6e73;
      --border: #e5e5ea;
      --primary: #0a84ff;
      --radius: 14px;
      --shadow: 0 10px 30px rgba(0,0,0,0.06), 0 4px 10px rgba(0,0,0,0.04);
      --tag-bg: #f2f2f7;
      --tag-text: #1d1d1f;
      --hover: #fafafa;
    }
    :root[data-theme="dark"] {
      --bg: #0b0b10;
      --card: #111218;
      --text: #e9e9ee;
      --muted: #9a9aa3;
      --border: #2a2a32;
      --primary: #64b5ff;
      --radius: 14px;
      --shadow: 0 10px 30px rgba(0,0,0,0.35), 0 4px 10px rgba(0,0,0,0.25);
      --tag-bg: #1b1c23;
      --tag-text: #e9e9ee;
      --hover: #14151c;
    }
    html, body { height: 100%; }
    body {
      margin: 0;
      background: var(--bg);
      color: var(--text);
      font-family: "Geist", Arial, Helvetica, sans-serif;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }
    .stem {line-height: 1.7; font-weight: 500;}
    .wrap { max-width: 1120px; margin: 0 auto; padding: 32px 24px; }
    header { display: flex; align-items: baseline; justify-content: space-between; margin-bottom: 24px; }
    header h1 { font-size: 22px; font-weight: 600; margin: 0; letter-spacing: .2px; }
    header .sub { color: var(--muted); font-size: 14px; }

    .grid { display: grid; grid-template-columns: 1fr 360px; gap: 24px; align-items: start; }
    .card { background: var(--card); border: 1px solid var(--border); border-radius: var(--radius); box-shadow: var(--shadow); }
    .card .content { padding: 20px 22px; }

    .question { border: 1px solid var(--border); border-radius: 10px; padding: 14px 14px 18px; margin-bottom: 12px; transition: border-color .2s, box-shadow .2s; }
    .question.correct { border-color: #34c759; box-shadow: 0 0 0 3px rgba(52,199,89,0.15); }
    .question.incorrect { border-color: #ff3b30; box-shadow: 0 0 0 3px rgba(255,59,48,0.12); }
    /* Subtle one-shot green glow when a correct answer is checked */
    .question.correct.glow-correct { animation: correctGlow 4s ease-out; }
    @keyframes correctGlow {
      0% { box-shadow: 0 0 0 3px rgba(52,199,89,0.15), 0 0 0 0 rgba(52,199,89,0); }
      35% { box-shadow: 0 0 0 3px rgba(52,199,89,0.18), 0 0 16px 6px rgba(52,199,89,0.22); }
      100% { box-shadow: 0 0 0 3px rgba(52,199,89,0.15), 0 0 0 0 rgba(52,199,89,0); }
    }
    /* Subtle one-shot red glow when an incorrect answer is checked */
    .question.incorrect.glow-incorrect { animation: incorrectGlow 4s ease-out; }
    @keyframes incorrectGlow {
      0% { box-shadow: 0 0 0 3px rgba(255,59,48,0.12), 0 0 0 0 rgba(255,59,48,0); }
      35% { box-shadow: 0 0 0 3px rgba(255,59,48,0.16), 0 0 16px 6px rgba(255,59,48,0.22); }
      100% { box-shadow: 0 0 0 3px rgba(255,59,48,0.12), 0 0 0 0 rgba(255,59,48,0); }
    }
    .question h2 { font-size: 16px; font-weight: 600; margin: 0 0 10px; letter-spacing: .2px; }
    .qmeta { color: var(--muted); font-size: 12px; margin-bottom: 12px; }
    .tags { display: flex; flex-wrap: wrap; gap: 6px; margin: 8px 0 6px; }
    .tag { background: var(--tag-bg); border: 1px solid var(--border); border-radius: 999px; padding: 2px 8px; font-size: 11px; color: var(--tag-text); }

    ul.choices { list-style: none; padding: 0; margin: 0; display: grid; gap: 8px; }
    .choice { display: flex; align-items: center; gap: 10px; padding: 10px 12px; border: 1px solid var(--border); border-radius: 10px; transition: border-color .2s, background .2s; }
    .choice input { accent-color: var(--primary); }
    .choice:hover { border-color: #d0d0d7; background: var(--hover); }

    .actions { padding: 16px 22px 22px; display: flex; gap: 8px; }
    button.primary { background: var(--text); color: white; border: none; padding: 10px 14px; border-radius: 12px; font-weight: 600; letter-spacing: .2px; cursor: pointer; }
    button.secondary { background: transparent; border: 1px solid var(--border); padding: 10px 14px; border-radius: 12px; cursor: pointer; }
    button.ghost { background: transparent; border: 1px solid var(--border); padding: 6px 10px; border-radius: 10px; cursor: pointer; font-size: 12px; }

    .sidebar { position: sticky; top: 24px; }
    .metric { display: flex; align-items: baseline; justify-content: space-between; margin-bottom: 8px; }
    .metric .label { color: var(--muted); font-size: 12px; }
    .metric .value { font-weight: 700; font-size: 20px; }
    .pill { display: inline-block; padding: 2px 8px; border-radius: 999px; background: var(--tag-bg); color: var(--tag-text); font-size: 11px; }
    .source { color: var(--muted); font-size: 11px; margin-top: 10px; word-break: break-all; }

    /* Outcome panel: constrain height and add a subtle scrollbar */
    #outcomeBox { max-height: 280px; overflow: auto; padding-right: 4px; }
    /* Firefox */
    #outcomeBox { scrollbar-width: thin; scrollbar-color: #c3c3c9 transparent; }
    /* WebKit */
    #outcomeBox::-webkit-scrollbar { width: 8px; height: 8px; }
    #outcomeBox::-webkit-scrollbar-track { background: transparent; border-radius: 8px; }
    #outcomeBox::-webkit-scrollbar-thumb { background: #d9d9de; border-radius: 8px; border: 2px solid transparent; background-clip: content-box; }
    #outcomeBox:hover::-webkit-scrollbar-thumb { background: #c3c3c9; }

    /* Floating theme toggle */
    .theme-toggle {
      position: fixed;
      top: 14px;
      right: 14px;
      z-index: 10000;
      background: var(--card);
      color: var(--text);
      border: 1px solid var(--border);
      border-radius: 999px;
      padding: 8px 10px;
      box-shadow: var(--shadow);
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      font-size: 13px;
    }
    .theme-toggle:focus { outline: 2px solid var(--primary); outline-offset: 2px; }
    @media (max-width: 480px) {
      .theme-toggle { padding: 8px; gap: 6px; }
      .theme-toggle .label { display: none; }
    }

    @media (max-width: 920px) {
      .grid { grid-template-columns: 1fr; }
      .sidebar { position: static; }
      #outcomeBox { max-height: 220px; }
    }

    /* ===== Mobile explanation popup ===== */
    .modal { position: fixed; inset: 0; display: none; z-index: 9999; }
    .modal.show { display: block; }
    .modal .backdrop { position: absolute; inset: 0; background: rgba(0,0,0,.45); }
    .modal .dialog { position: absolute; left: 50%; top: 50%; transform: translate(-50%, -50%);
      width: min(92vw, 560px); max-height: 80vh; background: var(--card); color: var(--text); border-radius: 14px; box-shadow: 0 10px 30px rgba(0,0,0,.25);
      display: flex; flex-direction: column; overflow: hidden; border: 1px solid var(--border); }
    .modal .head { display: flex; align-items: center; justify-content: space-between; padding: 10px 12px; border-bottom: 1px solid #f0f0f3; }
    .modal .head .title { font-weight: 700; }
    .modal .close { appearance: none; border: 0; background: transparent; font-size: 20px; line-height: 1; padding: 6px 10px; cursor: pointer; }
    .modal .body { padding: 12px; overflow: auto; }
    /* Subtle scrollbar for modal body */
    .modal .body { scrollbar-width: thin; scrollbar-color: #c3c3c9 transparent; }
    .modal .body::-webkit-scrollbar { width: 8px; height: 8px; }
    .modal .body::-webkit-scrollbar-track { background: transparent; border-radius: 8px; }
    .modal .body::-webkit-scrollbar-thumb { background: #d9d9de; border-radius: 8px; border: 2px solid transparent; background-clip: content-box; }
    .modal .body:hover::-webkit-scrollbar-thumb { background: #c3c3c9; }
    @media (prefers-color-scheme: dark) {
      .modal .dialog { background: #11131a; color: #f5f7fa; border-color: #202531; }
      .modal .head { border-bottom-color: #202531; }
    }

    /* Dedicated mini-scroll area for wide LaTeX */
    .math-scroll {
      display: block;
      max-width: 100%;
      overflow-x: auto;
      overflow-y: hidden;
      -webkit-overflow-scrolling: touch;
      margin: 6px 0;
      padding-bottom: 4px; /* room for thin scrollbar */
    }
    .math-scroll { scrollbar-width: thin; scrollbar-color: #c3c3c9 transparent; }
    .math-scroll::-webkit-scrollbar { height: 8px; }
    .math-scroll::-webkit-scrollbar-track { background: transparent; border-radius: 8px; }
    .math-scroll::-webkit-scrollbar-thumb { background: #d9d9de; border-radius: 8px; border: 2px solid transparent; background-clip: content-box; }
    .math-scroll:hover::-webkit-scrollbar-thumb { background: #c3c3c9; }
  </style>
</head>
<body>
  <button id="themeToggle" class="theme-toggle" type="button" aria-label="Toggle dark mode" title="Toggle theme">
    <span class="icon" aria-hidden="true">🌙</span>
    <span class="label">Dark</span>
  </button>
  <div class="wrap">
    <header>
      <h1>MCQ Quiz</h1>
      <div class="sub">{{ total }} questions</div>
    </header>

    <div class="grid">
      <form class="card" method="post" action="" id="quizForm" autocomplete="off">
        <div class="content">
          {% csrf_token %}
          {% for q in questions %}
            <section class="question" data-correct="{{ q.answer }}" data-qname="q{{ q.index }}" data-json='{{ q.json|escape }}'>
              <div class="qmeta">Question {{ q.index|add:1 }} of {{ total }}</div>
              <p class="stem">{{ q.text|linebreaksbr }}</p>
              <ul class="choices">
                {% for idx, choice in q.choices %}
                  <li class="choice">
                    <input type="radio" name="q{{ q.index }}" value="{{ idx }}" id="q{{ q.index }}_{{ idx }}" {% if q.selected == idx %}checked{% endif %}>
                    <label for="q{{ q.index }}_{{ idx }}">{{ choice }}</label>
                  </li>
                {% endfor %}
              </ul>
              {% if q.extras %}
              <div class="tags">
                {% for k, v in q.extras.items %}
                  <span class="tag">{{ k }}: {{ v }}</span>
                {% endfor %}
              </div>
              {% endif %}
              {% if q.explanation %}
              <div class="explanation" style="display:none; margin-top:10px;">
                <div class="pill" style="margin-bottom:6px; background:#fdeeee; color:#8a1f1f;">Explanation</div>
                <div>{{ q.explanation }}</div>
              </div>
              {% endif %}
            </section>
          {% endfor %}
        </div>
        <div class="actions">
          <a href="{% url 'reset' %}"><button class="secondary" type="button">Reset</button></a>
        </div>
      </form>

      <aside class="sidebar" id="sidebar">
        <div class="card" style="margin-bottom:16px;">
          <div class="content">
            <div class="metric"><span class="label">Score</span><span class="value" id="scoreValue">0 / {{ total }}</span></div>
            <div class="metric"><span class="label">Streak</span><span class="value" id="streakValue">0</span></div>
            <span class="pill" id="longestPill">Longest: 0</span>
          </div>
        </div>
        <div class="card">
          <div class="content">
            <div class="metric"><span class="label">Outcome</span><span class="value" id="outcomeStatus">â€”</span></div>
            <div id="outcomeBox" style="margin-top:8px;">
              <div class="pill" id="outcomePill">Awaiting checkâ€¦</div>
              <div id="outcomeBody" style="margin-top:10px; color: var(--muted); font-size: 13px;">Select an answer and press Check.</div>
              <div id="outcomeMeta" style="margin-top:12px;"></div>
            </div>
            <div class="source">Data: {{ data_source }}</div>
          </div>
        </div>
      </aside>
    </div>
  </div>

  <script>
    // Theme toggle behavior
    (function(){
      const btn = document.getElementById('themeToggle');
      if (btn) {
        const root = document.documentElement;
        const current = () => (root.getAttribute('data-theme') === 'dark') ? 'dark' : 'light';
        const updateButton = (theme) => {
          const icon = btn.querySelector('.icon');
          const label = btn.querySelector('.label');
          if (theme === 'dark') {
            if (icon) icon.textContent = '☀️';
            if (label) label.textContent = 'Light';
            btn.setAttribute('aria-label', 'Switch to light mode');
            btn.title = 'Switch to light mode';
          } else {
            if (icon) icon.textContent = '🌙';
            if (label) label.textContent = 'Dark';
            btn.setAttribute('aria-label', 'Switch to dark mode');
            btn.title = 'Switch to dark mode';
          }
        };
        const setTheme = (theme) => {
          root.setAttribute('data-theme', theme);
          try { localStorage.setItem('theme', theme); } catch(_) {}
          updateButton(theme);
        };
        updateButton(current());
        btn.addEventListener('click', () => setTheme(current()==='dark' ? 'light' : 'dark'));
      }
    })();

    // Per-question outcome panel
    (function(){
      const outcomeStatus = document.getElementById('outcomeStatus');
      const outcomePill = document.getElementById('outcomePill');
      const outcomeBody = document.getElementById('outcomeBody');
      const outcomeMeta = document.getElementById('outcomeMeta');
      const scoreEl = document.getElementById('scoreValue');
      const streakEl = document.getElementById('streakValue');
      const longestEl = document.getElementById('longestPill');
      const questions = Array.from(document.querySelectorAll('section.question'));

      // Wrap wide MathJax outputs in a mini horizontal scroller
      function __wrapWideMath(scopeEl){
        try {
          const root = scopeEl || document;
          const blocks = root.querySelectorAll('mjx-container');
          blocks.forEach((mjx) => {
            // Skip if already handled
            if (mjx.closest('.math-scroll')) return;
            const parent = mjx.parentElement;
            if (!parent) return;
            const mjxRect = mjx.getBoundingClientRect();
            // Choose bounds as the nearest scrolling ancestor or provided scope
            const boundsEl = scopeEl || parent;
            const boundsRect = boundsEl.getBoundingClientRect();
            if (mjxRect.width > Math.max(0, boundsRect.width - 8)) {
              // Use span to avoid invalid block-in-p structure; styled as block
              const wrap = document.createElement('span');
              wrap.className = 'math-scroll';
              parent.insertBefore(wrap, mjx);
              wrap.appendChild(mjx);
            }
          });
        } catch(_) {}
      }

      function setOutcome({title, ok, body, meta}){
        outcomeStatus.textContent = title;
        outcomePill.textContent = ok ? 'Right Answer' : 'Incorrect';
        outcomePill.style.background = ok ? '#e6f7ec' : '#fdeeee';
        outcomePill.style.color = ok ? '#106a36' : '#8a1f1f';
        // Use current theme text color for readability in light/dark modes
        try {
          const themeText = getComputedStyle(document.documentElement).getPropertyValue('--text').trim();
          outcomeBody.style.color = themeText || '';
        } catch(_) {
          outcomeBody.style.color = '';
        }
        outcomeBody.innerHTML = body;
        __typesetMath(outcomeBody).then(function(){ __wrapWideMath(outcomeBody); });
        // Render attributes
        if (meta) {
          let html = '<div style="display:grid;gap:6px">';
          for (const [k,v] of Object.entries(meta)) {
            const val = typeof v === 'object' ? JSON.stringify(v) : String(v);
            html += `<div style="display:flex;justify-content:space-between;gap:8px"><span class="label" style="color:var(--muted)">${k}</span><span>${val}</span></div>`;
          }
          html += '</div>';
          outcomeMeta.innerHTML = html;
        } else {
          outcomeMeta.innerHTML = '';
        }
      }

      function recomputeTotals(){
        const answers = questions.map(sec => {
          const correct = parseInt(sec.dataset.correct);
          const qname = sec.dataset.qname;
          const checked = document.querySelector(`input[name="${qname}"]:checked`);
          const val = checked ? parseInt(checked.value) : null;
          return (val !== null && val === correct);
        });
        const total = questions.length;
        const score = answers.filter(Boolean).length;
        let streak = 0; for (let i = answers.length - 1; i >= 0; i--) { if (answers[i]) streak++; else break; }
        let longest = 0, cur = 0; for (const a of answers) { if (a) { cur++; if (cur > longest) longest = cur; } else { cur = 0; } }
        scoreEl.textContent = `${score} / ${total}`;
        streakEl.textContent = `${streak}`;
        longestEl.textContent = `Longest: ${longest}`;
      }

      function onCheck(btn){
        const target = btn.dataset.target;
        const sec = document.querySelector(`section.question[data-qname="${target}"]`);
        if (!sec) return;
        const correct = parseInt(sec.dataset.correct);
        const json = JSON.parse(sec.dataset.json || '{}');
        const selected = document.querySelector(`input[name="${target}"]:checked`);
        if (!selected) {
          setOutcome({title: 'No selection', ok: false, body: 'Please choose an option, then press Check.', meta: null});
          recomputeTotals();
          return;
        }
        const chosenIdx = parseInt(selected.value);
        const ok = chosenIdx === correct;
        const choices = json.choices || [];
        const chosenText = choices[chosenIdx] ?? `Option ${chosenIdx+1}`;
        const correctText = choices[correct] ?? `Option ${correct+1}`;
        const explanation = json.explanation || json.explanations || '';
        const body = ok
          ? `<div><strong>${chosenText}</strong> is correct.</div>`
          : `<div style="margin-bottom:8px;">Your answer: <strong>${chosenText}</strong><br>Correct answer: <strong>${correctText}</strong></div>` + (explanation ? `<div>${explanation}</div>` : '');
        // Build attributes excluding heavy fields
        const meta = {...json};
        delete meta.text; delete meta.choices; delete meta.answer; delete meta.explanation; delete meta.explanations;
        setOutcome({title: `Question ${Number((target||'').replace('q',''))+1}`, ok, body, meta});
        // Add visual state on the question card
        sec.classList.toggle('correct', ok);
        sec.classList.toggle('incorrect', !ok);
        // Trigger a brief green glow (1.5s) when correct
        if (ok) {
          // Retrigger correct animation by removing then re-adding the class
          sec.classList.remove('glow-incorrect');
          sec.classList.remove('glow-correct');
          void sec.offsetWidth; // force reflow to restart animation
          sec.classList.add('glow-correct');
          setTimeout(() => sec.classList.remove('glow-correct'), 4100);
        } else {
          // Retrigger incorrect animation similarly
          sec.classList.remove('glow-correct');
          sec.classList.remove('glow-incorrect');
          void sec.offsetWidth;
          sec.classList.add('glow-incorrect');
          setTimeout(() => sec.classList.remove('glow-incorrect'), 4100);
        }
        // Report mistake once per question to server (Upstash-backed)
        if (!ok && !sec.dataset.reported) {
          try {
            // Capture the actual stem text for mistake payloads
            const stemEl = sec.querySelector('.stem');
            const labels = Array.from(sec.querySelectorAll('ul.choices label'));
            const choicesDom = labels.map(l => l.textContent || '');
            const explDom = (sec.querySelector('.explanation > div:last-child') || {}).innerHTML || explanation || '';
            const payload = {
              text: (stemEl ? (stemEl.textContent || '').trim() : (json.text || '')) || '',
              choices: choicesDom.length ? choicesDom : (json.choices || []),
              answer: correct,
              explanation: explDom,
              extras: json.extras || {},
            };
            fetch('/api/mistake/', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify(payload)
            }).catch(() => {});
            sec.dataset.reported = '1';
          } catch(_) {}
        }
        // On mobile, show explanation in a popup if incorrect
        if (!ok && window.matchMedia('(max-width: 920px)').matches) {
          showExplanationPopup(body);
        }
        recomputeTotals();
      }

      document.querySelectorAll('.check-btn').forEach(btn => {
        btn.addEventListener('click', () => onCheck(btn));
      });
      // Auto-check current question on selection change
      document.getElementById('quizForm').addEventListener('change', (e) => {
        recomputeTotals();
        const t = e.target;
        if (t && t.type === 'radio') {
          const sec = t.closest('section.question');
          if (sec) onCheck({ dataset: { target: sec.dataset.qname } });
        }
      });
      recomputeTotals();

      // Run MathJax over stems/options once loaded, then wrap wide formulas
      const quizForm = document.getElementById('quizForm');
      const runTypeset = () => {
        __typesetMath(quizForm || document).then(function(){ __wrapWideMath(quizForm || document); });
      };
      runTypeset();
      const mjxScript = document.getElementById('MathJax-script');
      if (mjxScript) {
        mjxScript.addEventListener('load', runTypeset);
      }

      // ===== Lightweight popup implementation =====
      function ensurePopup() {
        if (document.getElementById('explainModal')) return document.getElementById('explainModal');
        const host = document.createElement('div');
        host.id = 'explainModal';
        host.className = 'modal';
        host.innerHTML = `
          <div class="backdrop" data-close></div>
          <div class="dialog" role="dialog" aria-modal="true" aria-labelledby="explainTitle">
            <div class="head">
              <div class="title" id="explainTitle">Explanation</div>
              <button class="close" type="button" aria-label="Close" data-close>&times;</button>
            </div>
            <div class="body" id="explainBody"></div>
          </div>`;
        document.body.appendChild(host);
        host.addEventListener('click', (e) => {
          if (e.target && e.target.hasAttribute('data-close')) hideExplanationPopup();
        });
        window.addEventListener('keydown', (e) => {
          if (e.key === 'Escape') hideExplanationPopup();
        });
        return host;
      }
      // Preserve scroll position across popup open/close (mobile Safari safe)
      let __lockedScrollY = 0;
      function showExplanationPopup(html) {
        const modal = ensurePopup();
        const body = modal.querySelector('#explainBody');
        body.innerHTML = html;
        __typesetMath(body).then(function(){ __wrapWideMath(body); });
        modal.classList.add('show');
        // Lock background scroll without losing position
        // Capture current scroll position
        __lockedScrollY = window.scrollY || document.documentElement.scrollTop || 0;
        // Prevent background scroll on the root (helps Android/Chrome)
        document.documentElement.style.overflow = 'hidden';
        // Use fixed-position body lock (works reliably on iOS Safari)
        document.body.style.position = 'fixed';
        document.body.style.top = `-${__lockedScrollY}px`;
        document.body.style.left = '0';
        document.body.style.right = '0';
        document.body.style.width = '100%';
      }
      function hideExplanationPopup() {
        const modal = document.getElementById('explainModal');
        if (modal) modal.classList.remove('show');
        // Restore document flow and exact scroll position
        document.documentElement.style.overflow = '';
        const top = parseInt((document.body.style.top || '0').replace('px',''), 10) || 0;
        document.body.style.position = '';
        document.body.style.top = '';
        document.body.style.left = '';
        document.body.style.right = '';
        document.body.style.width = '';
        // Scroll back to where the user was
        const y = top ? -top : (__lockedScrollY || 0);
        window.scrollTo(0, y);
      }
    })();
  </script>
  <script>
    // Debug: log Upstash/local mistakes info when viewing the Mistakes page
    (function(){
      try {
        var dataSource = ("{{ data_source|default:'' }}" || '').toLowerCase();
        if (dataSource === 'mistakes') {
          console.log('[mistakes] data_source:', dataSource);
          fetch('/api/mistakes_count/')
            .then(r => r.json())
            .then(j => console.log('[mistakes] /api/mistakes_count ->', j))
            .catch(e => console.warn('[mistakes] count fetch error', e));
          fetch('/api/mistakes_dump/?limit=5')
            .then(r => r.json())
            .then(j => console.log('[mistakes] /api/mistakes_dump ->', j))
            .catch(e => console.warn('[mistakes] dump fetch error', e));
        }
      } catch (e) {}
    })();
  </script>
</body>
</html>
