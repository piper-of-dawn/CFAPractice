<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Flashcards - {{ name }}</title>
  <meta name="robots" content="noindex" />
  <meta name="referrer" content="no-referrer" />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;600&display=swap" rel="stylesheet">
  <style>
    :root {
      --border: #000;
      --grid-line: #000;
      --font: 'JetBrains Mono', ui-monospace, SFMono-Regular, Menlo, Consolas, 'Liberation Mono', 'Courier New', monospace;
    }
    * { box-sizing: border-box; }
    body { font-family: var(--font); margin: 0; color: #000; background: #fff7e6; }
    .noprint { padding: 12px 16px; background: #f5f5f5; border-bottom: 1px solid #ddd; }
    .noprint h1 { margin: 0 0 4px; font-size: 18px; }
    .noprint p { margin: 0; color: #333; }
    .noprint .actions { margin-top: 8px; }
    .noprint button { padding: 6px 12px; font-size: 14px; cursor: pointer; }

    .page { width: 210mm; height: 297mm; padding: 0; page-break-after: always; box-sizing: border-box; margin: 12px auto; }
    .label { font-size: 12px; color: #444; margin-bottom: 0; display: none !important; }
    .grid { display: grid; grid-template-columns: repeat(3, 1fr); grid-template-rows: repeat(4, 1fr); width: 100%; height: 100%; gap: 0; position: relative; }
    .cell { border: 0.3mm dotted #bdbdbd; padding: 8mm; display: flex; align-items: center; justify-content: center; text-align: center; overflow: hidden; }
    .front .cell .content { font-size: 12px; line-height: 1.2; }
    .back  .cell .content { font-size: 12px; line-height: 1.2; }
    .cell .content { max-width: 100%; word-break: break-word; overflow-wrap: anywhere; hyphens: auto; }
    .hint { position: absolute; top: -10px; right: 0; font-size: 10px; color: #777; display: none; }

    @media print {
      @page { size: 210mm 297mm; margin: 0; }
      .noprint { display: none; }
      .page { padding: 0; margin: 0; }
      .label { display: none !important; }
      .hint { display: block; }
    }
  </style>
  <script>
    // Fit text into each flashcard cell by shrinking font-size as needed.
    function fits(contentEl, container){
      const cw = container.clientWidth, ch = container.clientHeight;
      return contentEl.scrollWidth <= cw && contentEl.scrollHeight <= ch;
    }
    function fitOne(cell){
      const el = cell.querySelector('.content');
      if(!el) return;
      // Start at max 12px and only shrink if needed
      el.style.fontSize = '12px';
      let lo = 6, hi = 12, best = 12;
      for(let i=0;i<18;i++){
        const mid = (lo + hi) / 2;
        el.style.fontSize = mid.toFixed(2) + 'px';
        if(fits(el, cell)){
          best = mid; lo = mid;
        } else {
          hi = mid;
        }
        if(Math.abs(hi - lo) < 0.2) break;
      }
      el.style.fontSize = best.toFixed(2) + 'px';
    }
    function fitAll(){
      document.querySelectorAll('.page .cell').forEach(fitOne);
    }
    window.addEventListener('DOMContentLoaded', ()=>{
      if(window.MathJax && MathJax.startup && MathJax.startup.promise){
        MathJax.startup.promise.then(()=>{ fitAll(); });
      } else {
        fitAll();
      }
      if(document.fonts && document.fonts.ready){
        document.fonts.ready.then(()=>{ fitAll(); });
      }
    });
    window.addEventListener('resize', ()=>{ fitAll(); });
    if('onbeforeprint' in window){ window.addEventListener('beforeprint', fitAll); }
    if(window.matchMedia){
      const mq = window.matchMedia('print');
      if(mq && mq.addEventListener){ mq.addEventListener('change', e=>{ if(e.matches) fitAll(); }); }
    }
  </script>
  <script>
    // MathJax configuration for LaTeX rendering
    window.MathJax = {
      tex: { inlineMath: [['$', '$'], ['\\(', '\\)']], displayMath: [['$$','$$'], ['\\[','\\]']] },
      options: { renderActions: { addMenu: [] } },
      chtml: { scale: 1, matchFontHeight: false }
    };
  </script>
  <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js"></script>
</head>
<body>
  <div class="noprint">
    <h1>Flashcards for {{ name }}</h1>
    <p>Print settings: A4, no margins, 100% scale, print background graphics. Each batch produces two pages: front then back (back is mirrored for alignment).</p>
    <div class="actions">
      <button onclick="window.print()">Print</button>
      <a href="/flashcards/" style="margin-left:8px;">Back to files</a>
    </div>
  </div>

  {% for batch in batches %}
    <div class="page front">
      <div class="label">Front - Batch {{ forloop.counter }}</div>
      <div class="grid">
        {% for card in batch.fronts %}
          <div class="cell"><div class="content">{{ card.front|linebreaksbr }}</div></div>
        {% endfor %}
        <div class="hint">Cut along borders</div>
      </div>
    </div>

    <div class="page back">
      <div class="label">Back (mirrored) - Batch {{ forloop.counter }}</div>
      <div class="grid">
        {% for card in batch.backs %}
          <div class="cell"><div class="content">{{ card.back|linebreaksbr }}</div></div>
        {% endfor %}
        <div class="hint">Cut along borders</div>
      </div>
    </div>
  {% endfor %}
</body>
</html>
